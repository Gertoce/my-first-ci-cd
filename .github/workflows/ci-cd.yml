name: CI/CD Pipeline

# Триггеры
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Задачи
jobs:
  # Job 1: Сборка и тестирование на разных ОС
  build-and-test:
    # Запускаем на 3 разных ОС
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    # Шаг 1: Получаем код
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Шаг 2: Устанавливаем Go
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    # Шаг 3: Проверяем окружение
    - name: Show environment info
      run: |
        echo "=== Environment Information ==="
        go version
        echo "OS: ${{ runner.os }}"
        echo "Runner OS: $RUNNER_OS"
        echo "=============================="
    
    # Шаг 4: Скачиваем зависимости и создаем go.sum
    - name: Download dependencies
      run: go mod tidy
    
    # Шаг 5: Условное кэширование (только если go.sum существует)
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        # Ключ кэша зависит от ОС и содержимого go.sum, если он есть
        key: ${{ runner.os }}-go-mod-${{ hashFiles('go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-mod-
    
    # Шаг 6: Проверяем, что код компилируется
    - name: Check compilation
      run: go vet ./...
    
    # Шаг 7: Собираем
    - name: Build
      run: go build -o myapp .
    
    # Шаг 8: Запускаем тесты
    - name: Run tests
      run: go test -v ./...
    
    # Шаг 9: Сохраняем бинарник (версия v4)
    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: myapp-${{ runner.os }}
        path: myapp*
        if-no-files-found: error
